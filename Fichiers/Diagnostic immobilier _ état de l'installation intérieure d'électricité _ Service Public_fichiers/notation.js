define(["jquery","global"],function(t,e){"use strict";var a=!1,n=function(a,n){t(".sp-notation-list button[formaction]").on("mouseenter focus",function(){var e=t(this).parent().index();t(".sp-notation-list li").each(function(a){a<e&&t(this).find("button").addClass("sp-shining-star")})}),t(".sp-notation-list button[formaction]").on("mouseleave blur",function(){t(".sp-notation-list button").removeClass("sp-shining-star")}),t(".sp-notation-list button[formaction]").click(function(r){r.preventDefault();var d={audience:a,idFiche:n,note:t(this).attr("formaction"),_csrf:e.getCsrfHeader().token};t.ajax({url:"/notation/note",method:"POST",data:d}).done(function(e,a,n){o(d.note),t("[data-test=notation-feedback-success]").removeAttr("hidden"),t("[data-test=notation-feedback-success]").focus()}).fail(function(e){var a=e.status;a&&412===a?(t("[data-test=notation-feedback-failure]").removeAttr("hidden"),t("[data-test=notation-rated]").removeAttr("hidden"),t("[data-test=notation-feedback-failure]").focus()):(t("[data-test=notation-feedback-success]").attr("hidden","hidden"),t("[data-test=notation-feedback-error]").removeAttr("hidden"),t("[data-test=notation-rated]").removeAttr("hidden"),t("[data-test=notation-feedback-error]").focus())}).always(function(){t("div[data-test=notation-form]").remove()})})},o=function(e){t("[data-test=notation-form]").remove(),r(e),d(e),t("[data-test=notation-rated]").removeAttr("hidden"),t("input[name=note]").attr("value",e),t("h3[data-test=notation-feedback-form-title-ameliorerpage]").removeAttr("hidden"),t("h2[data-test=notation-feedback-form-title-quizpage]").removeAttr("hidden"),t("div[data-test=notation-feedback-form-title-quiz]").removeAttr("hidden"),t("div[data-test=notation-feedback-form-submit]").removeAttr("hidden"),t("input[name=email]").removeAttr("required"),t("input[name=email]").attr("aria-required","false"),t("textarea[name=message]").removeAttr("required"),t("textarea[name=message]").attr("aria-required","false"),a=!0},r=function(e){switch(e){case"5":t("[data-test=notation-rated-value-5]").removeAttr("hidden"),t("[data-test=notation-rated-value-4]").removeAttr("hidden"),t("[data-test=notation-rated-value-3]").removeAttr("hidden"),t("[data-test=notation-rated-value-2]").removeAttr("hidden"),t("[data-test=notation-rated-value-1]").removeAttr("hidden");break;case"4":t("[data-test=notation-rated-value-4]").removeAttr("hidden"),t("[data-test=notation-rated-value-3]").removeAttr("hidden"),t("[data-test=notation-rated-value-2]").removeAttr("hidden"),t("[data-test=notation-rated-value-1]").removeAttr("hidden");break;case"3":t("[data-test=notation-rated-value-3]").removeAttr("hidden"),t("[data-test=notation-rated-value-2]").removeAttr("hidden"),t("[data-test=notation-rated-value-1]").removeAttr("hidden");break;case"2":t("[data-test=notation-rated-value-2]").removeAttr("hidden"),t("[data-test=notation-rated-value-1]").removeAttr("hidden");break;case"1":t("[data-test=notation-rated-value-1]").removeAttr("hidden")}},d=function(e){switch(e){case"5":t("[data-test=notation-rated-alert-success-value-1]").remove(),t("[data-test=notation-rated-alert-success-value-2]").remove(),t("[data-test=notation-rated-alert-success-value-3]").remove(),t("[data-test=notation-rated-alert-success-value-4]").remove(),t("[data-test=notation-rated-label-value-5]").removeAttr("hidden"),t("[data-test=notation-rated-alert-success-value-5]").removeAttr("aria-hidden");break;case"4":t("[data-test=notation-rated-alert-success-value-1]").remove(),t("[data-test=notation-rated-alert-success-value-2]").remove(),t("[data-test=notation-rated-alert-success-value-3]").remove(),t("[data-test=notation-rated-alert-success-value-5]").remove(),t("[data-test=notation-rated-label-value-4]").removeAttr("hidden"),t("[data-test=notation-rated-alert-success-value-4]").removeAttr("aria-hidden");break;case"3":t("[data-test=notation-rated-alert-success-value-1]").remove(),t("[data-test=notation-rated-alert-success-value-2]").remove(),t("[data-test=notation-rated-alert-success-value-4]").remove(),t("[data-test=notation-rated-alert-success-value-5]").remove(),t("[data-test=notation-rated-label-value-3]").removeAttr("hidden"),t("[data-test=notation-rated-alert-success-value-3]").removeAttr("aria-hidden");break;case"2":t("[data-test=notation-rated-alert-success-value-1]").remove(),t("[data-test=notation-rated-alert-success-value-3]").remove(),t("[data-test=notation-rated-alert-success-value-4]").remove(),t("[data-test=notation-rated-alert-success-value-5]").remove(),t("[data-test=notation-rated-label-value-2]").removeAttr("hidden"),t("[data-test=notation-rated-alert-success-value-2]").removeAttr("aria-hidden");break;case"1":t("[data-test=notation-rated-alert-success-value-2]").remove(),t("[data-test=notation-rated-alert-success-value-3]").remove(),t("[data-test=notation-rated-alert-success-value-4]").remove(),t("[data-test=notation-rated-alert-success-value-5]").remove(),t("[data-test=notation-rated-label-value-1]").removeAttr("hidden"),t("[data-test=notation-rated-alert-success-value-1]").removeAttr("aria-hidden")}},i=function(a,n,o,r){function d(){t("#replace_div").load("/AIFEchecked"),require(["captcha/captchetat-js"],function(){t(document).ready(function(){require(["captcha/captcha-aife"],function(e){var a=setInterval(function(){t("#captchetat").length&&(e.showCaptchaAIFEV(),clearInterval(a))},500)})})})}var i,v,f=t("input[name=souhaiteEcrire]"),k=t("div[data-test=notation-feedback-form-message]"),b=t("div[data-test=notation-feedback-recaptcha]"),A=t("div[data-test=notation-feedback-form-submit]"),g=t("input[data-notation=tropDInfos]"),q=t("input[data-notation=pasSatisfait]"),E=t("input[data-notation=pasMaSituation]"),I=t("input[data-notation=manqueInfos]"),F=t("input[data-notation=infosPasClaires]"),C=t("input[data-notation=infosFausses]"),_=t("div[data-test=notation-feedback-form]"),x=(f.prop("checked"),I.prop("checked"),F.prop("checked"),C.prop("checked"),[I,F,C]),y=[g,q,E];for(i=0;i<x.length;i++){c(x,x[i],f,k,b,A)}for(v=0;v<y.length;v++){s(y,y[v],f,k,b,A)}f.prop("checked",!1),I.change(function(){!0===this.checked&&1===t("#replace_div").length&&(r?d():callCaptchaAIFE())}),F.change(function(){!0===this.checked&&1===t("#replace_div").length&&(r?d():callCaptchaAIFE())}),C.change(function(){!0===this.checked&&1===t("#replace_div").length&&(r?d():callCaptchaAIFE())}),f.click(function(e){!0===t(this).prop("checked")?(1===t("#replace_div").length&&(r?d():callCaptchaAIFE()),u(f,k,b,A)):l(f,k,b,A)}),t("form[data-test=feedback-form]").on("submit",function(r){r.preventDefault(),t("[data-test=notation-feedback-captcha-error]").attr("hidden","hidden");var d={audience:a,idFiche:n,titreFiche:o,urlFiche:"/"+a+"/vosdroits/"+n,note:_.find("[name=note]").val(),satellite:_.find("[name=satellite]").val(),satelliteQPM:_.find("[name=satelliteQPM]").val(),souhaiteEcrire:_.find("[name=souhaiteEcrire]").is(":checked"),email:_.find("[name=email]").val(),message:_.find("[name=message]").val(),comprehension:_.find("[name=comprehension]:checked").val()||-1,utilite:_.find("[name=utilite]:checked").val()||-1,manqueInfos:_.find("[data-notation=manqueInfos]").is(":checked"),tropDInfos:_.find("[data-notation=tropDInfos]").is(":checked"),infosFausses:_.find("[data-notation=infosFausses]").is(":checked"),pasSatisfait:_.find("[data-notation=pasSatisfait]").is(":checked"),infosPasClaires:_.find("[data-notation=infosPasClaires]").is(":checked"),pasMaSituation:_.find("[data-notation=pasMaSituation]").is(":checked"),captchaId:_.find("[name=captchaId]").val(),captchaCode:_.find("[name=captchaCode]").val(),_csrf:e.getCsrfHeader().token};t.ajax({url:"/notation/feedback",method:"POST",data:d}).done(function(e,a,n){if("captcha_error"===n.responseText||n.responseJSON&&n.responseJSON.captcha_error){var o=n.responseJSON?n.responseJSON.captcha_error:"";return t("[data-test=notation-feedback-captcha-error]").html(o),t("[data-test=notation-feedback-captcha-error]").removeAttr("hidden"),t("#captchaFormulaireExtInput").parent().addClass("fr-input-group--error"),t("#captchaFormulaireExtInput").addClass("fr-input--error"),t("#captchaFormulaireExtInput").focus(),t("input[name=captchaCode]").val(""),void t(document).ready(function(){document.getElementById("botdetect-captcha")&&(t("#botdetect-captcha").captcha({captchaEndpoint:"/simple-captcha-endpoint"}),setTimeout(function(){t("#captchaFormulaireExtInput").attr("aria-describedby","error-div-captcha captcha-hint2"),t("#captchaFormulaireExtInput").focus()},2e3))})}t("div[data-test=notation-feedback-form]").remove(),t("[data-test=notation-feedback-success]").attr("hidden","hidden"),t("[data-test=notation-feedback-success-moreinfo]").removeAttr("hidden"),t("[data-test=notation-feedback-success-moreinfo]").focus()}).fail(function(e){var a=e.status;!a||412!==a&&403!==a?(t("[data-test=notation-feedback-success]").attr("hidden","hidden"),t("[data-test=notation-feedback-error]").removeAttr("hidden"),t("[data-test=notation-feedback-error]").focus()):(t("[data-test=notation-feedback-success]").attr("hidden","hidden"),t("[data-test=notation-feedback-failure]").removeAttr("hidden"),t("[data-test=notation-feedback-failure]").focus()),t("div[data-test=notation-feedback-form]").remove()}).always(function(){t("[data-test=notation-alert]").remove()})}),h(),m(f,k,b,A,I,F,C),p()},s=function(t,e,a,n,o,r){e.prop("checked",!1),e.click(function(t){l(a,n,o,r),a.removeAttr("disabled")})},c=function(e,a,n,o,r,d){a.prop("checked",!1),a.click(function(a){!0===t(this).prop("checked")?(u(n,o,r,d),t("input[name=souhaiteEcrire]").attr("disabled","disabled")):!1===t(this).prop("checked")&&(!0===e[0].prop("checked")||!0===e[1].prop("checked")||!0===e[2].prop("checked")?(u(n,o,r,d),t("input[name=souhaiteEcrire]").attr("disabled","disabled")):(l(n,o,r,d),t("input[name=souhaiteEcrire]").removeAttr("disabled")))})},u=function(e,a,n,o){e.prop("checked",!0),a.removeAttr("hidden"),o.removeAttr("hidden"),n.removeAttr("hidden"),t("input[name=email]").attr("required","required"),t("input[name=email]").attr("aria-required","true"),t("textarea[name=message]").attr("required","required"),t("textarea[name=message]").attr("aria-required","true"),t("input[name=validation_cgu_feedback]").attr("required","required"),t("input[name=validation_cgu_feedback]").attr("aria-required","true")},l=function(e,n,o,r){e.prop("checked",!1),n.attr("hidden","hidden"),o.attr("hidden","hidden"),t("input[name=validation_cgu_feedback]").removeAttr("required"),t("input[name=validation_cgu_feedback]").removeAttr("aria-required"),t("input[name=email]").removeAttr("required"),t("input[name=email]").removeAttr("aria-required"),t("input[name=email]")[0].setCustomValidity(""),t("textarea[name=message]").removeAttr("required"),t("textarea[name=message]").removeAttr("aria-required"),a||r.attr("hidden","hidden")},m=function(t,e,a,n,o,r,d){var i=document.querySelectorAll('#sp-feedback-radio-button input[type="radio"]');i.forEach(function(s){s.addEventListener("click",function(){i.forEach(function(i){i!==s&&(i.checked=!1),!0===o.prop("checked")||!0===r.prop("checked")||!0===d.prop("checked")?(u(t,e,a,n),t.attr("disabled","disabled")):(l(t,e,a,n),t.removeAttr("disabled"))})})})},v=function(){t("div[data-test=notation-feedback-form]").removeAttr("hidden"),document.getElementById("make-remark").style.display="none"},h=function(){var t=document.getElementById("make-remark");null!==t&&t.addEventListener("click",v)},f=function(){t('div[data-test="notation-feedback-success"]').hide()},p=function(){var t=document.getElementById("remove-notation-success");null!==t&&t.addEventListener("click",f)};return{initNotation:n,initFeedbackForm:i}});