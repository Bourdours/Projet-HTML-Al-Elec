define(["jquery","mustache","text!choice-tree/choiceTreeTemplate.html","text!choice-tree/choiceTreeAideTemplate.html","global","vddTooltip","persoGeo"],function(e,t,n,i,a,c,r){function o(){function a(t){e(t).find("[class]").removeAttr("class"),e(t).find("[id]").removeAttr("id"),e(t).find("[data-application]").removeAttr("data-application")}function c(a){function o(e){if(0===e.children(p).length)return"";var n={aideId:e.children(p).children("button").attr("aria-controls"),aideTitle:e.children(p).children("button").attr("title"),aideText:e.children(b).html()};return t.render(i,n)}function d(e){return t.render(n,e)}function l(e,t){0!==t.length?e.$toSelectChoices=t.children(u):e.$toSelectChoices=e.$immutableChoiceTree.children(u)}function s(t,n){var i=n.parents(u).toArray().reverse();0!==n.length&&i.push(n),t.$recapChoices=e(i)}function E(t,n){if(0!==n.length){var i="";n.children(u).each(function(){i+=e(this).html()}),t.printableContent=i}else t.printableContent=e(t.$immutableChoiceTree).html()}a=function(t){function n(t){var n=[];return t.each(function(t,i){var a={id:t,title:e(i).children(m).text(),notice:e(i).children(f).html(),noticeIsNotBlank:0!==e(i).children(f).text().trim().length,listNumber:t+1,aideBloc:o(e(i)),content:function(){var t=e(i).children("[data-immutable-choice-tree=title]").attr("data-condition");if(t){var n="requirejs(['jquery', 'domReady'], function ($, domReady) { domReady(function () { $('body').trigger('agenda', '"+t+"');});});",a='<div class="schedule"><ul id="agenda" class="schedule-list-day"></ul><script>'+n+"<\/script></div>",c=e(i).children("div.choice-tree-item-content");return e(c).children("p:eq(0)").hide(),a=a+"<br>"+e(c).html()}return e(i).children("div.choice-tree-item-content").html()}};n.push(a)}),n}return t.toSelectChoicesNodes=n(t.$toSelectChoices),t.recapChoicesNodes=n(t.$recapChoices),t.ghostNumber=t.recapChoicesNodes.length+1,t.content=function(e){if(0===e.toSelectChoicesNodes.length){return e.recapChoicesNodes[e.recapChoicesNodes.length-1].content}return null}(t),t}(a),function(e){var t=e.$parentElement;t.find(v).remove(),e.$choiceTreeNextSibling.length>0?e.$choiceTreeNextSibling.before(d(e)):t.append(d(e))}(a),function(t){t.$parentElement.find(T).each(function(n,i){e(i).on("click",function(){var n=e(t.$toSelectChoices.get(e(i).data("nodeId")));l(t,n),s(t,n),E(t,n),c(t),t.$parentElement.find(g).remove(),e(x).removeAttr("tabindex");var a=t.$parentElement.find(y).find(x);a.last().attr("tabindex","-1"),a.last().focus(),0===t.$parentElement.find(T).length&&t.$parentElement.find($).attr("hidden","hidden")})})}(a),function(t){var n=t.$parentElement;n.find(N).each(function(i,a){e(a).on("click",function(){var i=e(t.$recapChoices.get(e(a).data("nodeId")));t.isNotModifyAction=!1;var r=n.find(N);l(t,i.parent(u)),s(t,i.parent(u)),E(t,i.parent(u)),c(t);var o;r[0]===a?o=t.$parentElement.find($).children(S):(r=e(N),o=e(r).last()),o.attr("tabindex","0"),o.focus()})})}(a),function(t){t.find("[data-application=geoSearchForm]").each(function(t,n){r.execute(e(n))})}(a.$parentElement),function(){var t=e(v+":eq("+a.choiceTreeId+")");0===e("[data-id=rdv_gendarmerie]").length&&t.find(g).last().focus(),h(t.find(C))}()}function o(e){l(e,"sigle"),l(e,"acronyme")}function d(e){l(e,"definition")}function l(t,n){e(t).find("abbr[data-"+n+"], span[data-"+n+"]").each(function(){var t=this,i=e(t).data()[n],a=e("div[data-"+n+"="+i+"]"),c=a.text();e(t).attr("data-original-title",c);var r=e(t).children("span.fr-tooltip"),o="tooltip-"+e(t).data().id+"-visible";r.attr("id",o).text(c),e(t).attr("aria-describedby",o)})}function h(t){t.find(".collapse").on("shown.bs.collapse",function(t){e(this).attr("aria-hidden",!1)}),t.find(".collapse").on("hidden.bs.collapse",function(t){e(this).attr("aria-hidden",!0)})}var s,u="[data-immutable-choice-tree=item]",m="[data-immutable-choice-tree=title]",f="[data-immutable-choice-tree=notice]",p="[data-immutable-choice-tree=aide-button]",b="[data-immutable-choice-tree=aide-texte]",v="[data-dynamic-choice-tree=root]",g="[data-dynamic-choice-tree=focus]",$="[data-dynamic-choice-tree=to-select]",y="[data-dynamic-choice-tree=recap]",C="[data-dynamic-choice-tree=result]",T="[data-dynamic-choice-tree=select-action]",N="[data-dynamic-choice-tree=modify-action]",x="[data-dynamic-tree=title]",S="[data-dynamic-choice-tree=choisir-cas]",E=e("[data-immutable-choice-tree=root]");E.each(function(t,n){s=e(n).clone(!0,!0),o(s.get(0)),d(s.get(0));var i=e('meta[name="identifier"]'),r=e('meta[name="technicalType"]'),l={$toSelectChoices:s.children(u),toSelectChoicesNodes:[],$recapChoices:e(),recapChoicesNodes:[],$parentElement:e(n).parent("div"),choiceTreeId:t,$immutableChoiceTree:s,$choiceTreeNextSibling:e(n).next(),ghostNumber:0,content:null,printableContent:null,isNotModifyAction:!0,isLetterTemplate:i.length>0&&i.attr("content").startsWith("R")&&r.length>0&&"lettreTypeNG"===r.attr("content")};l.$toSelectChoices.length>1&&(e(n).attr("hidden",!0),a(n),l.printableContent=e(n).html(),c(l))}),e("body").on("shown.bs.modal",function(t){var n=e(t.relatedTarget).attr("data-target-hashcode");n&&e("#btn-fermer-"+n).focus()})}return{transform:o}});